<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Zoe Network | Premium Dashboard</title>

  <!-- Resource hints -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://js.paystack.co">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">

  <!-- Paystack (still deferred – only used on click) -->
  <script src="https://js.paystack.co/v1/inline.js" defer></script>
  
  <!-- Supabase – NO defer so the global 'supabase' is ready before our script runs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #00b578;
      --primary-dark: #009663;
      --bg: #f4f5f7;
      --text: #1a1a1a;
      --gray: #888;
      --white: #fff;
      --danger: #ff3b30;
      --glass: rgba(255,255,255,0.7);
      --glass-border: rgba(255,255,255,0.4);
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:110px;overflow-x:hidden}

    .header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:24px 16px 72px;border-bottom-left-radius:28px;border-bottom-right-radius:28px}
    .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .user-info{display:flex;align-items:center;gap:10px}
    .avatar-top{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.35);object-fit:cover}
    .balance-section{text-align:center}
    .balance-amount{font-size:38px;font-weight:800;margin:4px 0;letter-spacing:-1px}
    .interest-tag{font-size:11px;background:rgba(255,255,255,.25);padding:4px 12px;border-radius:20px;font-weight:700}

    .action-card{background:#fff;width:92%;margin:-50px auto 24px;padding:20px;border-radius:24px;display:grid;grid-template-columns:1fr 1fr;gap:16px;box-shadow:0 10px 24px rgba(0,0,0,.1);z-index:10}
    .action-btn{background:none;border:none;display:flex;flex-direction:column;align-items:center;cursor:pointer}
    .action-icon{width:50px;height:50px;border-radius:16px;display:flex;justify-content:center;align-items:center;font-size:22px;margin-bottom:6px;transition:.18s}
    .action-btn:active .action-icon{transform:scale(.92)}
    .icon-add{background:#e8f5f0;color:var(--primary)}
    .icon-withdraw{background:#fff0f0;color:var(--danger)}
    .action-btn span{font-size:13px;font-weight:700;color:#444}

    .section{padding:0 16px;margin-top:24px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .section-title{font-size:15px;font-weight:800}
    .card{background:#fff;padding:18px;border-radius:20px;box-shadow:0 3px 12px rgba(0,0,0,.04)}
    .progress-meta{display:flex;justify-content:space-between;font-size:12px;font-weight:700;margin-bottom:8px}
    .bar-bg{height:8px;background:#f0f0f0;border-radius:4px;overflow:hidden}
    .bar-fill{height:100%;background:var(--primary);width:0%;transition:width 1.4s ease-out}

    .activity-item{display:flex;align-items:center;gap:14px;padding:10px 0;border-bottom:1px solid #f6f6f6}
    .activity-item:last-child{border-bottom:0}
    .activity-icon{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:16px}
    .activity-details{flex:1}
    .activity-name{font-size:13px;font-weight:700}
    .activity-date{font-size:11px;color:var(--gray)}
    .activity-val{font-size:13px;font-weight:800;color:var(--primary)}

    .sidebar{position:fixed;inset:0 auto 0 -100%;width:85%;max-width:320px;height:100%;background:var(--glass);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);border-right:1px solid var(--glass-border);box-shadow:2px 0 20px rgba(0,0,0,.12);z-index:2000;transition:left .36s cubic-bezier(.4,0,.2,1);padding:36px 0;color:var(--text)}
    .sidebar.open{left:0}
    .sidebar-header{text-align:center;padding:0 16px 28px}
    .avatar-large{width:90px;height:90px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,.3);margin-bottom:12px}
    .sidebar-name{font-size:19px;font-weight:800;color:#111}
    .menu-list{list-style:none}
    .menu-item{padding:14px 24px;display:flex;align-items:center;gap:16px;color:#222;text-decoration:none;font-weight:600;font-size:14.5px;transition:.2s}
    .menu-item i{font-size:19px;color:var(--primary);width:24px;text-align:center}
    .menu-item:hover,.menu-item:active{background:rgba(255,255,255,.3);color:var(--primary);padding-left:30px}
    .menu-item[style*="--danger"] i{color:var(--danger)!important}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);z-index:1900;display:none}

    .bottom-nav{position:fixed;bottom:16px;left:4%;width:92%;background:var(--glass);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);display:flex;justify-content:space-around;padding:10px 0;border-radius:22px;border:1px solid var(--glass-border);box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:1000}
    .nav-item{text-align:center;color:#777;font-size:10px;font-weight:700;flex:1;text-decoration:none}
    .nav-item.active{color:var(--primary)}
    .nav-icon{font-size:18px;margin-bottom:3px;display:block}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:3000;justify-content:center;align-items:flex-end}
    .modal-content{background:#fff;padding:24px;width:100%;border-radius:28px 28px 0 0;animation:slideUp .28s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .input-pay{width:100%;padding:14px;font-size:15px;border:1.5px solid #eee;border-radius:12px;margin-bottom:12px;outline:none}
    .btn-main{width:100%;padding:16px;border-radius:14px;border:none;font-weight:800;cursor:pointer;margin-bottom:8px;font-size:15px}
    .btn-green{background:var(--primary);color:#fff}
    .btn-gray{background:#f4f5f7;color:var(--text)}
  </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <img src="" id="menuAvatar" class="avatar-large" loading="lazy" alt="User avatar">
    <h2 id="menuName" class="sidebar-name">User</h2>
  </div>
  <nav class="menu-list">
    <a href="dashboard.html" class="menu-item"><i class="fa fa-home"></i> Home</a>
    <a href="profile.html" class="menu-item"><i class="fa fa-id-card"></i> My Identity</a>
    <a href="loan.html" class="menu-item"><i class="fa fa-money-bill-transfer"></i> Apply for Loan</a>
    <a href="history.html" class="menu-item"><i class="fa fa-list-ul"></i> Transactions</a>
    <a href="support.html" class="menu-item"><i class="fa fa-headset"></i> Support Chat</a>
    <a href="#" class="menu-item" onclick="logout()" style="color:var(--danger)"><i class="fa fa-sign-out-alt" style="color:var(--danger)"></i> Logout</a>
  </nav>
</div>

<div class="header">
  <div class="top-bar">
    <div class="user-info">
      <img src="" class="avatar-top" id="mainAvatar" onclick="toggleMenu()" loading="lazy" alt="User">
      <div>
        <span style="font-size:9px;opacity:.85;font-weight:600">Welcome back,</span>
        <h1 id="userName" style="font-size:15px;font-weight:800;margin:0">User</h1>
      </div>
    </div>
    <div onclick="toggleMenu()" style="background:rgba(255,255,255,.18);width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center">
      <i class="fa fa-bars-staggered" style="font-size:19px"></i>
    </div>
  </div>
  <div class="balance-section">
    <div style="font-size:10px;opacity:.9;text-transform:uppercase;letter-spacing:.8px;font-weight:700">Wallet Balance</div>
    <div class="balance-amount" id="walletBal">₦0.00</div>
    <div class="interest-tag"><i class="fa fa-arrow-trend-up"></i> + ₦<span id="interestDisplay">0.00</span> Interest</div>
  </div>
</div>

<div class="action-card">
  <button class="action-btn" onclick="openModal('topupModal')">
    <div class="action-icon icon-add"><i class="fa fa-plus-circle"></i></div>
    <span>Add Money</span>
  </button>
  <button class="action-btn" onclick="checkWithdrawalStatus()">
    <div class="action-icon icon-withdraw"><i class="fa fa-building-columns"></i></div>
    <span>Withdraw</span>
  </button>
</div>

<div class="section">
  <div class="section-header">
    <div class="section-title">Savings Maturity (365 Days)</div>
  </div>
  <div class="card">
    <div class="progress-meta">
      <span id="progressPercent" style="color:var(--primary)">0% Completed</span>
      <span id="daysCounter">0 / 365 Days</span>
    </div>
    <div class="bar-bg"><div class="bar-fill" id="progressBar"></div></div>
    <p style="font-size:11px;color:var(--gray);margin-top:12px;line-height:1.4">
      <i class="fa fa-circle-info"></i> Funds locked for 1 year. Early withdrawal resets progress + 10% penalty.
    </p>
  </div>
</div>

<div class="section" style="margin-bottom:32px">
  <div class="section-header">
    <div class="section-title">Recent Activities</div>
    <a href="history.html" style="font-size:12px;color:var(--primary);font-weight:700;text-decoration:none">View All</a>
  </div>
  <div class="card" id="activityList">
    <p style="text-align:center;color:#999;font-size:12px;margin:10px 0">No recent transactions</p>
  </div>
</div>

<div class="modal" id="withdrawModal">
  <div class="modal-content">
    <h3 style="text-align:center;margin:0 0 16px">Withdraw Funds</h3>
    <div id="payoutCalc" style="background:#f9fafb;padding:14px;border-radius:14px;margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px">
        <span>Wallet Balance:</span><b id="wBal">₦0</b>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px">
        <span id="pLabel">Interest:</span><b id="pVal" style="color:var(--primary)">+ ₦0</b>
      </div>
      <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
      <div style="display:flex;justify-content:space-between;font-size:15px;font-weight:800">
        <span>Total Payout:</span><b id="totalPayout">₦0</b>
      </div>
    </div>
    <div id="penaltyWarning" style="background:#fff0f0;color:var(--danger);padding:10px;border-radius:10px;font-size:11px;margin-bottom:14px;display:none;font-weight:600">
      <i class="fa fa-triangle-exclamation"></i> Early Withdrawal: 10% penalty.
    </div>
    <input type="text" id="bankName" class="input-pay" placeholder="Bank Name">
    <input type="text" id="accNum" class="input-pay" placeholder="Account Number">
    <input type="text" id="accName" class="input-pay" placeholder="Account Name">
    <button class="btn-main btn-green" onclick="processWithdrawal()">Confirm & Reset Savings</button>
    <button class="btn-main btn-gray" onclick="closeModal('withdrawModal')">Close</button>
  </div>
</div>

<div class="modal" id="topupModal">
  <div class="modal-content">
    <h3 style="text-align:center;margin:0 0 16px">Top Up Account</h3>
    <input type="number" id="topupAmount" class="input-pay" placeholder="Amount (₦)" min="100">
    <button class="btn-main btn-green" onclick="payWithPaystack()">Pay Now (Instant)</button>
    <button class="btn-main btn-gray" onclick="submitCashPayment()">I Paid Cash</button>
    <button class="btn-main btn-gray" onclick="closeModal('topupModal')">Cancel</button>
  </div>
</div>

<nav class="bottom-nav">
  <a href="dashboard.html" class="nav-item active"><i class="fa fa-house nav-icon"></i>Home</a>
  <a href="history.html" class="nav-item"><i class="fa fa-clock-rotate-left nav-icon"></i>History</a>
  <a href="loan.html" class="nav-item"><i class="fa fa-hand-holding-dollar nav-icon"></i>Loan</a>
  <a href="#" onclick="logout()" class="nav-item"><i class="fa fa-right-from-bracket nav-icon"></i>Logout</a>
</nav>

<script>
const SUPABASE_URL = 'https://bvnivavjmrmfnagwqvxc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2bml2YXZqbXJtZm5hZ3dxdnhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODE2NDksImV4cCI6MjA4Njg1NzY0OX0.KRKwRllUSm8lqJZQ1H68v9nQjXYh1fqw9qmlyAiFBS0';

// Correct Supabase CDN usage – destructuring createClient
const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

let user = JSON.parse(localStorage.getItem('zoe_user'));
let profile = null;
let earnedInterest = 0;
const INTEREST_RATE = 0.10;

window.addEventListener('load', async () => {
  if (!user) return location.href = 'index.html';
  await loadData();
});

async function loadData() {
  const { data, error } = await client.from('profiles').select('*').eq('id', user.id).single();
  if (error || !data) return;
  profile = data;
  updateUI(data);
  loadActivities();
}

function updateUI(data) {
  document.getElementById('userName').textContent = data.full_name?.split(' ')[0] || 'User';
  document.getElementById('menuName').textContent = data.full_name || 'User';

  const bal = Number(data.balance || 0);
  document.getElementById('walletBal').textContent = `₦${bal.toLocaleString()}`;

  const start = new Date(data.savings_start_date || data.created_at);
  const days = Math.floor((Date.now() - start) / 86400000);
  const progress = Math.min(days / 365 * 100, 100);

  document.getElementById('progressBar').style.width = progress + '%';
  document.getElementById('progressPercent').textContent = Math.floor(progress) + '% Completed';
  document.getElementById('daysCounter').textContent = `${Math.min(days, 365)} / 365 Days`;

  earnedInterest = bal * INTEREST_RATE * (Math.min(days, 365) / 365);
  document.getElementById('interestDisplay').textContent = earnedInterest.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

  const av = data.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.full_name || 'User')}&background=00b578&color=fff&bold=true`;
  document.getElementById('mainAvatar').src = av;
  document.getElementById('menuAvatar').src = av;
}

function checkWithdrawalStatus() {
  if (!profile) return;
  const start = new Date(profile.savings_start_date || profile.created_at);
  const days = Math.floor((Date.now() - start) / 86400000);
  const bal = Number(profile.balance || 0);

  document.getElementById('wBal').textContent = `₦${bal.toLocaleString()}`;

  if (days < 365) {
    const penalty = bal * 0.1;
    document.getElementById('pLabel').textContent = 'Early Penalty (10%):';
    document.getElementById('pVal').textContent = `- ₦${penalty.toLocaleString()}`;
    document.getElementById('pVal').style.color = 'var(--danger)';
    document.getElementById('totalPayout').textContent = `₦${(bal - penalty).toLocaleString()}`;
    document.getElementById('penaltyWarning').style.display = 'block';
  } else {
    const total = bal + earnedInterest;
    document.getElementById('pLabel').textContent = 'Interest Earned:';
    document.getElementById('pVal').textContent = `+ ₦${earnedInterest.toLocaleString(undefined,{minimumFractionDigits:2})}`;
    document.getElementById('pVal').style.color = 'var(--primary)';
    document.getElementById('totalPayout').textContent = `₦${total.toLocaleString()}`;
    document.getElementById('penaltyWarning').style.display = 'none';
  }
  openModal('withdrawModal');
}

async function processWithdrawal() {
  const bank = document.getElementById('bankName').value.trim();
  const acc  = document.getElementById('accNum').value.trim();
  const name = document.getElementById('accName').value.trim();
  if (!bank || !acc || !name) return alert('Please fill bank details');

  // 1. CALCULATE FINAL PAYOUT (Penalty or Interest)
  const start = new Date(profile.savings_start_date || profile.created_at);
  const days = Math.floor((Date.now() - start) / 86400000);
  const currentBal = Number(profile.balance || 0);
  
  let finalPayout = currentBal;

  if (days < 365) {
    // Apply 10% Penalty for early withdrawal
    const penalty = currentBal * 0.10;
    finalPayout = currentBal - penalty;
  } else {
    // Add 10% Interest for reaching maturity
    const interest = currentBal * INTEREST_RATE;
    finalPayout = currentBal + interest;
  }

  // 2. INSERT CALCULATED AMOUNT (Admin will see this)
  const { error: wErr } = await client.from('withdrawals').insert({
    user_id: user.id,
    amount: finalPayout, // Sending the penalized/interested amount
    bank_name: bank,
    account_number: acc,
    account_name: name,
    status: 'pending'
  });

  if (wErr) return alert('Error submitting request');

  // 3. RESET USER PROFILE
  const { error: rErr } = await client.from('profiles').update({
    balance: 0,
    savings_start_date: new Date().toISOString()
  }).eq('id', user.id);

  if (!rErr) {
    // 4. SANITIZE PHONE & SEND SMS
    let cleanPhone = profile.phone.toString().replace(/\D/g, ''); 
    if (cleanPhone.startsWith('0')) {
        cleanPhone = '234' + cleanPhone.substring(1);
    }

    fetch(`https://bvnivavjmrmfnagwqvxc.supabase.co/functions/v1/Sms`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
      body: JSON.stringify({ 
        phone: cleanPhone, 
        message: `Zoe: Withdrawal request for ₦${finalPayout.toLocaleString()} received. Your savings progress has been reset.` 
      })
    }).catch(()=>{});

    alert(`Withdrawal request submitted for ₦${finalPayout.toLocaleString()}. Savings reset.`);
    location.reload();
  }
}

async function loadActivities() {
  const { data } = await client.from('contributions')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false })
    .limit(3);

  const list = document.getElementById('activityList');
  if (!data?.length) return;

  list.innerHTML = data.map(c => `
    <div class="activity-item">
      <div class="activity-icon" style="background:${c.status==='approved'?'#e8f5f0':'#fff8e0'};color:${c.status==='approved'? 'var(--primary)':'#f59e0b'}">
        <i class="fa ${c.status==='approved'?'fa-check':'fa-clock'}"></i>
      </div>
      <div class="activity-details">
        <p class="activity-name">Deposit via ${c.type.toUpperCase()}</p>
        <p class="activity-date">${new Date(c.created_at).toLocaleDateString()}</p>
      </div>
      <div class="activity-val">+ ₦${Number(c.amount).toLocaleString()}</div>
    </div>
  `).join('');
}

function payWithPaystack() {
  const amt = Number(document.getElementById('topupAmount').value);
  if (!amt || amt < 100) return alert('Minimum ₦100');

  PaystackPop.setup({
    key: 'pk_live_988851c6dff5a63928310640a0265fe5b7d254af',
    email: profile.email || `${profile.phone}@zoe.network`,
    amount: Math.round(amt * 100),
    currency: 'NGN',
    callback: () => syncToDatabase(amt)
  }).openIframe();
}
async function syncToDatabase(amt) {
  // 1. Calculate the new balance accurately
  const currentBal = Number(profile.balance || 0);
  const newBal = currentBal + Number(amt);
  
  // 2. Update the Database Profile balance
  const { error: upError } = await client.from('profiles')
    .update({ balance: newBal })
    .eq('id', user.id);

  if (upError) return alert("Update failed: " + upError.message);

  // 3. Insert the Contribution Record
  await client.from('contributions').insert([{ 
    user_id: user.id, 
    amount: amt, 
    status: 'approved', 
    type: 'paystack' 
  }]);

  // 4. CLEAN THE PHONE NUMBER (Fixes Error 107)
  let cleanPhone = profile.phone.toString().replace(/\D/g, ''); 
  if (cleanPhone.startsWith('0')) {
    cleanPhone = '234' + cleanPhone.substring(1);
  }

  // 5. Trigger SMS via Edge Function
  try {
    await fetch(`https://bvnivavjmrmfnagwqvxc.supabase.co/functions/v1/Sms`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json', 
        'Authorization': `Bearer ${SUPABASE_KEY}` 
      },
      body: JSON.stringify({ 
        phone: cleanPhone, 
        message: `Zoe: Your payment of ₦${Number(amt).toLocaleString()} was successful. Your new wallet balance is ₦${newBal.toLocaleString()}.` 
      })
    });
  } catch (smsErr) {
    console.error("SMS failed to send:", smsErr);
  }

  // 6. Final UI Refresh
  alert(`Success! ₦${Number(amt).toLocaleString()} added to your wallet.`);
  location.reload();
}

async function submitCashPayment() {
  const amt = document.getElementById('topupAmount').value;
  if (!amt || amt < 100) return alert('Minimum ₦100');
  
  // 1. Record the pending cash payment
  const { error } = await client.from('contributions').insert([{ 
    user_id: user.id, 
    amount: amt, 
    status: 'pending', 
    type: 'cash' 
  }]);
  
  if (!error) {
    // 2. Send "Reviewing" SMS (Balance is NOT sent here because it hasn't changed yet)
    try {
      await fetch(`https://bvnivavjmrmfnagwqvxc.supabase.co/functions/v1/Sms`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': `Bearer ${SUPABASE_KEY}` 
        },
        body: JSON.stringify({ 
          phone: profile.phone, 
          message: `Zoe: Your cash deposit of ₦${Number(amt).toLocaleString()} is under review by admin. Your balance will update once approved.` 
        })
      });
    } catch(e) {}

    alert('Cash payment recorded – awaiting approval');
    closeModal('topupModal');
  }
}

function toggleMenu() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('open');
  document.getElementById('overlay').style.display = sidebar.classList.contains('open') ? 'block' : 'none';
}

function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function logout() { localStorage.clear(); location.href = 'index.html'; }
</script>
</body>
</html>