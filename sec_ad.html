<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zoe Admin | Mobile Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #00b578; 
            --danger: #ff3b30; 
            --warning: #ff9500; 
            --info: #007aff;
            --dark: #1a1a1a;
            --bg: #f8f9fb;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--dark); line-height: 1.5; padding-bottom: 40px; }

        .container { width: 100%; max-width: 1200px; margin: auto; padding: 15px; }

        .header-flex { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        @media (min-width: 768px) { .header-flex { flex-direction: row; justify-content: space-between; align-items: center; } }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        @media (min-width: 768px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }

        .stat-card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border-left: 4px solid var(--primary); }
        .stat-card h4 { margin: 0; color: #888; font-size: 10px; text-transform: uppercase; }
        .stat-card p { margin: 5px 0 0; font-size: 16px; font-weight: 800; }

        /* Request Cards */
        .section-title { font-size: 16px; font-weight: 800; margin: 25px 0 15px; display: flex; align-items: center; gap: 10px; padding-left: 5px; }
        
        .request-card { 
            background: white; 
            padding: 15px; 
            border-radius: 18px; 
            margin-bottom: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #eee;
        }
        .req-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .req-user { font-weight: 800; font-size: 14px; }
        .req-meta { font-size: 11px; color: #777; }
        .req-amount { font-size: 18px; font-weight: 900; color: var(--dark); }

        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Buttons */
        .btn { padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 13px; text-align: center; }
        .btn-approve { background: var(--primary); color: white; }
        .btn-reject { background: #fee; color: var(--danger); }
        .btn-view { background: #f0f0f0; color: var(--dark); }

        .badge { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .bg-loan { background: #eef2ff; color: #4f46e5; }
        .bg-interest { background: #fffbeb; color: #b45309; }

        /* User Table */
        .search-box { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 15px; margin-bottom: 15px; font-size: 16px; }
        .table-container { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-flex">
            <div>
                <h1 style="margin:0; font-size: 24px;">Zoe Admin <span style="color:var(--primary)">Hub</span></h1>
                <p style="color:#888; margin:0; font-size: 13px;" id="lastRefreshed"></p>
            </div>
            <button onclick="openAdminQuickPay()" style="background:#007bff; color:white; border:none; padding:12px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">
    <i class="fas fa-check-double"></i> Manual Day Payment
</button>

            <button class="btn btn-view" onclick="loadAllData()">
                <i class="fas fa-sync-alt"></i> Sync Data
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h4>Main Balances</h4>
                <p id="statMainBal">₦0</p>
            </div>
            <div class="stat-card" style="border-color: var(--info);">
                <h4>Loan Balances</h4>
                <p id="statLoanBal">₦0</p>
            </div>
            <div class="stat-card" style="border-color: var(--warning);">
                <h4>Pending Tasks</h4>
                <p id="statPending">0</p>
            </div>
            <div class="stat-card" style="border-color: var(--danger);">
                <h4>Loan Requests</h4>
                <p id="statLoanReqs">0</p>
            </div>
        </div>
        
        

        <div class="section-title"><i class="fas fa-money-bill-wave" style="color:var(--primary)"></i> Payment Verifications</div>
        <div id="paymentList">Loading payments...</div>

        <div class="section-title"><i class="fas fa-hand-holding-usd" style="color:var(--info)"></i> Loan Disbursements</div>
        <div id="loanDisbursementList">Loading requests...</div>

        <div class="section-title"><i class="fas fa-arrow-circle-up" style="color:var(--danger)"></i> Standard Withdrawals</div>
        <div id="withdrawalList">Loading payouts...</div>

        <div class="section-title"><i class="fas fa-users"></i> Member Management</div>
        <input type="text" id="userSearch" class="search-box" placeholder="Search member name or phone..." oninput="renderUsers()">
        <div class="table-container">
            <table>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>
<div id="adminQuickPayModal" class="modal" style="display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8);">
    <div style="background:white; margin:10% auto; padding:20px; width:90%; max-width:400px; border-radius:15px; position:relative;">
        <span onclick="closeModal('adminQuickPayModal')" style="position:absolute; right:15px; top:10px; font-size:24px; cursor:pointer;">&times;</span>
        
        <h3>Manual Loan Payment</h3>
        <input type="text" id="adminUserSearch" placeholder="Search name or phone..." 
               onkeyup="filterQuickPayUsers()" 
               style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
        
        <div id="quickPayList" style="max-height:300px; overflow-y:auto;">
            </div>
    </div>
</div>

</div>


    <script>
        const SUPABASE_URL = 'https://bvnivavjmrmfnagwqvxc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2bml2YXZqbXJtZm5hZ3dxdnhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODE2NDksImV4cCI6MjA4Njg1NzY0OX0.KRKwRllUSm8lqJZQ1H68v9nQjXYh1fqw9qmlyAiFBS0';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allUsers = [];

        window.onload = loadAllData;

        async function loadAllData() {
            document.getElementById('lastRefreshed').innerText = "Refreshing...";
            
            // 1. Load Payments (Cash Main / Cash Loan / Interest)
            const { data: payments } = await client.from('contributions').select('*, profiles(full_name, phone)').eq('status', 'pending');
            renderPayments(payments);

            // 2. Load Loan Requests (Disbursements)
            const { data: loanReqs } = await client.from('loan_requests').select('*, profiles(full_name, phone)').eq('status', 'pending');
            renderLoanRequests(loanReqs);

            // 3. Load Standard Withdrawals
            const { data: withdrawals } = await client.from('withdrawals').select('*, profiles(full_name, phone)').eq('status', 'pending');
            renderWithdrawals(withdrawals);

            // 4. Load User Directory
            const { data: users } = await client.from('profiles').select('*').order('full_name');
            allUsers = users;
            renderUsers();

            updateStats(users, payments, loanReqs, withdrawals);
            document.getElementById('lastRefreshed').innerText = "Last synced: " + new Date().toLocaleTimeString();
        }

        function updateStats(users, p, l, w) {
            let mainTotal = users.reduce((acc, curr) => acc + (parseFloat(curr.balance) || 0), 0);
            let loanTotal = users.reduce((acc, curr) => acc + (parseFloat(curr.loan_balance) || 0), 0);
            document.getElementById('statMainBal').innerText = `₦${mainTotal.toLocaleString()}`;
            document.getElementById('statLoanBal').innerText = `₦${loanTotal.toLocaleString()}`;
            document.getElementById('statPending').innerText = (p?.length || 0) + (w?.length || 0);
            document.getElementById('statLoanReqs').innerText = (l?.length || 0);
        }

        function renderPayments(list) {
            const container = document.getElementById('paymentList');
            if(!list || list.length === 0) { container.innerHTML = '<p style="padding:15px; color:#999;">No pending payments</p>'; return; }
            
            container.innerHTML = list.map(item => `
                <div class="request-card">
                    <div class="req-info">
                        <div>
                            <div class="req-user">${item.profiles.full_name}</div>
                            <div class="req-meta">${item.profiles.phone}</div>
                            <span class="badge ${item.category === 'loan_savings' ? 'bg-loan' : 'bg-interest'}">${item.category.replace('_', ' ')}</span>
                        </div>
                        <div class="req-amount">₦${item.amount.toLocaleString()}</div>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-approve" onclick="approvePayment('${item.id}', '${item.user_id}', ${item.amount}, '${item.category}', '${item.profiles.phone}')">Confirm Recieved</button>
                        <button class="btn btn-reject" onclick="deleteRecord('contributions', '${item.id}')">Decline</button>
                    </div>
                </div>
            `).join('');
        }

        function renderLoanRequests(list) {
            const container = document.getElementById('loanDisbursementList');
            if(!list || list.length === 0) { container.innerHTML = '<p style="padding:15px; color:#999;">No loan requests</p>'; return; }

            container.innerHTML = list.map(item => `
                <div class="request-card" style="border-left: 5px solid var(--info);">
                    <div class="req-info">
                        <div>
                            <div class="req-user">${item.profiles.full_name}</div>
                            <div class="req-meta">${item.bank_name} | ${item.account_number}</div>
                            <small style="color:var(--primary); font-weight:bold;">Interest Prepaid: ₦${item.interest_amount}</small>
                        </div>
                        <div class="req-amount">₦${item.amount.toLocaleString()}</div>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-approve" style="background:var(--info)" onclick="approveLoanDisbursement('${item.id}', '${item.user_id}', ${item.amount}, '${item.profiles.phone}')">Mark Disbursed</button>
                        <button class="btn btn-reject" onclick="deleteRecord('loan_requests', '${item.id}')">Decline</button>
                    </div>
                </div>
            `).join('');
        }

        function renderWithdrawals(list) {
            const container = document.getElementById('withdrawalList');
            if(!list || list.length === 0) { container.innerHTML = '<p style="padding:15px; color:#999;">No pending withdrawals</p>'; return; }

            container.innerHTML = list.map(item => `
                <div class="request-card" style="border-left: 5px solid var(--danger);">
                    <div class="req-info">
                        <div>
                            <div class="req-user">${item.profiles.full_name}</div>
                            <div class="req-meta">${item.bank_name} | ${item.account_number}</div>
                        </div>
                        <div class="req-amount">₦${item.amount.toLocaleString()}</div>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-approve" style="background:var(--danger)" onclick="approveWithdrawal('${item.id}', '${item.user_id}', ${item.amount}, '${item.profiles.phone}')">Mark Paid</button>
                        <button class="btn btn-reject" onclick="deleteRecord('withdrawals', '${item.id}')">Decline</button>
                    </div>
                </div>
            `).join('');
        }

        function renderUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(u => u.full_name.toLowerCase().includes(search) || u.phone.includes(search));
            
            document.getElementById('userTableBody').innerHTML = filtered.map(u => `
                <tr>
                    <td>
                        <div style="font-weight:800; font-size:14px;">${u.full_name}</div>
                        <div style="font-size:11px; color:#888;">${u.phone}</div>
                        <div style="margin-top:5px;">
                            <span class="badge" style="background:#eee">Main: ₦${(u.balance || 0).toLocaleString()}</span>
                            <span class="badge" style="background:#eef2ff; color:#4f46e5">Loan: ₦${(u.loan_balance || 0).toLocaleString()}</span>
                        </div>
                    </td>
                    <td style="text-align:right">
                        <button class="btn" style="background:var(--dark); color:white; padding:8px 12px;" onclick="manualTopup('${u.id}', '${u.full_name}', '${u.phone}')"><i class="fas fa-plus"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        // --- ACTION LOGIC ---

        // --- UPDATED ACTION LOGIC ---

// --- FIXED APPROVE PAYMENT ---
async function approvePayment(id, uid, amt, category, phone) {
    if (!confirm(`Approve this payment of ₦${Number(amt).toLocaleString()}?`)) return;

    try {
        // 1. Fetch user profile to get current savings and day count
        const { data: profile, error: pError } = await client.from('profiles').select('*').eq('id', uid).single();
        if (pError) throw new Error("Profile not found");

        let message = "";

        if (category === 'loan_repayment') {
            // --- LOAN REPAYMENT LOGIC ---
            
            // Get the current active loan
            const { data: activeLoan } = await client.from('loan_requests')
                .select('*')
                .eq('user_id', uid)
                .eq('status', 'approved')
                .maybeSingle();

            if (!activeLoan) throw new Error("No active loan found for this user.");

            // MATH: 84% goes to loan, 16% goes to savings (as per your +16% request)
            // If they pay 1000: 840 reduces debt, 160 goes to their savings wallet
            const principalReduction = Number(amt) * 0.84; 
            const savingsPortion = Number(amt) * 0.16; 

            // Update Profile: Increment Day + Add the 16% to their Savings Balance
            const nextDay = (Number(profile.loan_days) || 0) + 1;
            await client.from('profiles').update({
                loan_days: nextDay,
                loan_balance: (Number(profile.loan_balance) || 0) + savingsPortion,
                updated_at: new Date().toISOString()
            }).eq('id', uid);

            // Update Loan: Reduce the debt
            const remainingDebt = Math.max(0, activeLoan.amount - principalReduction);
            await client.from('loan_requests').update({
                amount: remainingDebt,
                status: remainingDebt <= 0 ? 'repaid' : 'approved'
            }).eq('id', activeLoan.id);

            message = `Zoe: Payment Approved! Day ${nextDay}/90. ₦${Math.round(savingsPortion)} added to your savings. Remaining debt: ₦${Math.round(remainingDebt).toLocaleString()}`;

        } else {
            // --- REGULAR SAVINGS APPROVAL ---
            const newBal = (Number(profile.loan_balance) || 0) + Number(amt);
            await client.from('profiles').update({ loan_balance: newBal }).eq('id', uid);
            message = `Zoe: Your savings of ₦${Number(amt).toLocaleString()} has been approved. New balance: ₦${newBal.toLocaleString()}`;
        }

        // Finalize: Mark the contribution as approved
        await client.from('contributions').update({ status: 'approved' }).eq('id', id);

        await sendSms(phone, message);
        alert("Payment processed successfully!");
        loadAllData(); // Refresh admin list

    } catch (err) {
        console.error(err);
        alert("Error: " + err.message);
    }
}


async function runLateAudit() {
    try {
        const { data: activePayers, error } = await client.from('profiles')
            .select('id, full_name, phone, updated_at, loan_days')
            .gt('loan_days', 0); // Only people currently repaying

        // FIX: Check if error exists or if data is empty/null
        if (error) {
            console.error("Audit Query Error:", error.message);
            return;
        }

        if (!activePayers || activePayers.length === 0) {
            console.log("Audit: No active payers found to check.");
            return;
        }

        for (let u of activePayers) {
            if (!u.updated_at) continue; // Skip if they haven't started yet

            const lastUpdate = new Date(u.updated_at);
            const hoursLate = Math.floor((new Date() - lastUpdate) / (1000 * 60 * 60));

            // If late by 30 hours or more
            if (hoursLate >= 30) {
                const daysLate = Math.floor(hoursLate / 24);
                await sendSms(u.phone, `URGENT Zoe: ${u.full_name}, you are ${daysLate} day(s) late. A 10% penalty is being added to your debt daily until you pay.`);
                console.log(`Late alert sent to ${u.full_name} (${hoursLate}h late)`);
            }
        }
    } catch (err) {
        console.error("Unexpected Audit Crash:", err);
    }
}

// --- FIXED LOAN DISBURSEMENT ---
async function approveLoanDisbursement(id, uid, amt, phone) {
    if(!confirm("Confirm Disbursement: Have you transferred the funds?")) return;

    const { error: loanError } = await client.from('loan_requests')
        .update({ 
            status: 'approved',
            disbursed_at: new Date().toISOString() 
        })
        .eq('id', id);

    if (loanError) return alert("Update failed");

    await client.from('profiles').update({
        loan_days: 0,
        updated_at: new Date().toISOString()
    }).eq('id', uid);

    await sendSms(phone, `Zoe: Your loan of ₦${amt.toLocaleString()} is disbursed. Repayment starts at Day 0.`);
    alert("Loan disbursed!");
    loadAllData(); 
}


async function approveLoanDisbursement(id, uid, amt, phone) {
    if(!confirm("Confirm Disbursement: Have you transferred the funds? This starts the user at Day 0.")) return;

    // 1. Update Loan Request Status
    const { error: loanError } = await client.from('loan_requests')
        .update({ 
            status: 'approved',
            disbursed_at: new Date().toISOString() 
        })
        .eq('id', id);

    if (loanError) return alert("Update failed: " + loanError.message);

    // 2. Initialize Repayment Tracker (Reset to Day 0)
    const { error: profileError } = await client.from('profiles').update({
        loan_days: 0,
        updated_at: new Date().toISOString()
    }).eq('id', uid);

    if (profileError) return alert("Profile sync failed: " + profileError.message);

    // 3. UI Feedback
    document.getElementById('loanDisbursementList').innerHTML = "<p style='padding:15px;'>Syncing records...</p>";
    
    // 4. Send Notification & Refresh
    await sendSms(phone, `Zoe: Your loan of ₦${amt.toLocaleString()} is disbursed. Repayment starts at Day 0. Good luck!`);
    await loadAllData(); 
    
    alert("Loan marked as disbursed. User dashboard will now switch to Repayment Mode.");
}

// Function to show the modal and clear old search
function openAdminQuickPay() {
    document.getElementById('adminUserSearch').value = '';
    filterQuickPayUsers();
    document.getElementById('adminQuickPayModal').style.display = 'block';
}

function filterQuickPayUsers() {
    const searchTerm = document.getElementById('adminUserSearch').value.toLowerCase();
    const list = document.getElementById('quickPayList');
    
    // Filters based on the global allUsers array
    const filtered = allUsers.filter(u => 
        u.full_name.toLowerCase().includes(searchTerm) || u.phone.includes(searchTerm)
    );

    list.innerHTML = filtered.map(u => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
            <div>
                <strong>${u.full_name}</strong>
                <div style="font-size:11px; color:#888;">Day ${u.loan_days || 0}/90</div>
            </div>
            <button onclick="confirmManualTick('${u.id}', '${u.full_name}', ${u.loan_days || 0})" 
                    style="background:#28a745; color:white; border:none; padding:8px 12px; border-radius:5px;">
                Tick Paid
            </button>
        </div>
    `).join('');
}

async function confirmManualTick(uid, name, currentDay) {
    if (!confirm(`Mark Day ${currentDay + 1} as paid for ${name}?`)) return;

    const { data: profile } = await client.from('profiles').select('*').eq('id', uid).single();
    
    const { data: loan } = await client.from('loan_requests')
        .select('amount')
        .eq('user_id', uid)
        .eq('status', 'approved')
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

    if (!loan) return alert("User has no active approved loan.");

    const baseDaily = loan.amount / 90;
    const savingsToReturn = baseDaily * 0.20;
    const newDay = (currentDay || 0) + 1;
    const newLoanBal = (parseFloat(profile.loan_balance) || 0) + savingsToReturn;

    const { error } = await client.from('profiles').update({
        loan_days: newDay,
        loan_balance: newLoanBal
    }).eq('id', uid);

    if (!error) {
        await client.from('contributions').insert([{
            user_id: uid,
            amount: baseDaily * 1.20,
            status: 'approved',
            type: 'cash',
            category: 'loan_repayment'
        }]);

        document.getElementById('adminQuickPayModal').style.display = 'none';

        // Use the global helper we just fixed
        if (profile.phone) {
            await sendSms(profile.phone, `Zoe Admin: Day ${newDay} payment confirmed. ₦${Math.round(savingsToReturn)} added to your wallet.`);
        }

        alert(`${name} is now on Day ${newDay}.`);
        loadAllData();
    } else {
        alert("Update failed: " + error.message);
    }
}


        async function approveWithdrawal(id, uid, amt, phone) {
            if(!confirm("Mark as paid?")) return;
            // When standard withdrawal is approved, user balance is usually already deducted on request. 
            // If not, deduct it here. For safety, we just mark as completed.
            await client.from('withdrawals').update({ status: 'completed' }).eq('id', id);
            sendSms(phone, `Zoe Network: Your withdrawal of ₦${amt.toLocaleString()} has been paid. check your bank.`);
            loadAllData();
        }

        
        async function manualTopup(uid, name, phone) {
    const type = prompt(`Top up for ${name}\nType '1' for Main Balance\nType '2' for Loan Balance`);
    if(!type) return;

    const amt = prompt("Enter Amount:");
    if(!amt || isNaN(amt)) return alert("Invalid amount");

    const parsedAmt = parseFloat(amt);
    const userProfile = allUsers.find(u => u.id === uid);
    
    let updateData = {};
    let newTotal = 0;
    let balanceType = "";

    // 1. Calculate the new total based on the selection
    if (type === '1') {
        newTotal = (Number(userProfile.balance) || 0) + parsedAmt;
        updateData.balance = newTotal;
        balanceType = "Main Wallet";
    } else if (type === '2') {
        newTotal = (Number(userProfile.loan_balance) || 0) + parsedAmt;
        updateData.loan_balance = newTotal;
        balanceType = "Loan Wallet";
    } else {
        return alert("Invalid type selection.");
    }

    // 2. Update the database
    const { error } = await client.from('profiles').update(updateData).eq('id', uid);

    if (!error) {
        // 3. Send SMS with the specific balance updated and the new total
        const message = `Zoe Admin: Your ${balanceType} has been credited with ₦${parsedAmt.toLocaleString()}. New balance: ₦${newTotal.toLocaleString()}.`;
        
        await sendSms(phone, message);

        alert(`Success! ${name}'s ${balanceType} is now ₦${newTotal.toLocaleString()}.`);
        loadAllData();
    } else {
        alert("Database update failed: " + error.message);
    }
}

        
        
        async function deleteRecord(table, id) {
            if(!confirm("Are you sure you want to decline/delete this request?")) return;
            await client.from(table).delete().eq('id', id);
            loadAllData();
        }

        async function sendSms(phone, msg) {
    if (!phone) {
        console.error("SMS Error: No phone number provided.");
        return;
    }

    // Clean the phone number (Convert 080... to 23480...)
    let cleanPhone = phone.toString().replace(/\D/g, ''); 
    if (cleanPhone.startsWith('0')) {
        cleanPhone = '234' + cleanPhone.substring(1);
    }

    console.log(`Sending SMS to ${cleanPhone}...`);

    try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/Sms`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${SUPABASE_KEY}` 
            },
            body: JSON.stringify({ 
                phone: cleanPhone, 
                to: cleanPhone, // Added 'to' as an alias to satisfy gateway requirements
                message: msg 
            })
        });
        
        const result = await response.text();
        console.log("SMS Gateway Result:", result);
        return result;
    } catch(e) { 
        console.error("SMS skip due to network error", e); 
    }
}


    </script>
</body>
</html>
