<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zoe Admin | Mobile Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #00b578; 
            --danger: #ff3b30; 
            --warning: #ff9500; 
            --info: #007aff;
            --dark: #1a1a1a;
            --bg: #f8f9fb;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--dark); line-height: 1.5; padding-bottom: 40px; }

        .container { width: 100%; max-width: 1200px; margin: auto; padding: 15px; }

        .header-flex { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        @media (min-width: 768px) { .header-flex { flex-direction: row; justify-content: space-between; align-items: center; } }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        @media (min-width: 768px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }

        .stat-card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border-left: 4px solid var(--primary); }
        .stat-card h4 { margin: 0; color: #888; font-size: 10px; text-transform: uppercase; }
        .stat-card p { margin: 5px 0 0; font-size: 16px; font-weight: 800; }

        /* Request Cards */
        .section-title { font-size: 16px; font-weight: 800; margin: 25px 0 15px; display: flex; align-items: center; gap: 10px; padding-left: 5px; }
        
        .request-card { 
            background: white; 
            padding: 15px; 
            border-radius: 18px; 
            margin-bottom: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #eee;
        }
        .req-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .req-user { font-weight: 800; font-size: 14px; }
        .req-meta { font-size: 11px; color: #777; }
        .req-amount { font-size: 18px; font-weight: 900; color: var(--dark); }

        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Buttons */
        .btn { padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 13px; text-align: center; }
        .btn-approve { background: var(--primary); color: white; }
        .btn-reject { background: #fee; color: var(--danger); }
        .btn-view { background: #f0f0f0; color: var(--dark); }

        .badge { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .bg-loan { background: #eef2ff; color: #4f46e5; }
        .bg-interest { background: #fffbeb; color: #b45309; }

        /* User Table */
        .search-box { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 15px; margin-bottom: 15px; font-size: 16px; }
        .table-container { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-flex">
            <div>
                <h1 style="margin:0; font-size: 24px;">Zoe Admin <span style="color:var(--primary)">Hub</span></h1>
                <p style="color:#888; margin:0; font-size: 13px;" id="lastRefreshed"></p>
            </div>
            <button onclick="openAdminQuickPay()" style="background:#007bff; color:white; border:none; padding:12px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">
    <i class="fas fa-check-double"></i> Manual Day Payment
</button>

            <button class="btn btn-view" onclick="loadAllData()">
                <i class="fas fa-sync-alt"></i> Sync Data
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h4>Main Balances</h4>
                <p id="statMainBal">₦0</p>
            </div>
            <div class="stat-card" style="border-color: var(--info);">
                <h4>Loan Balances</h4>
                <p id="statLoanBal">₦0</p>
            </div>
            <div class="stat-card" style="border-color: var(--warning);">
                <h4>Pending Tasks</h4>
                <p id="statPending">0</p>
            </div>
            <div class="stat-card" style="border-color: var(--danger);">
                <h4>Loan Requests</h4>
                <p id="statLoanReqs">0</p>
            </div>
        </div>
        
        

        <div class="section-title"><i class="fas fa-money-bill-wave" style="color:var(--primary)"></i> Payment Verifications</div>
        <div id="paymentList">Loading payments...</div>

        <div class="section-title"><i class="fas fa-hand-holding-usd" style="color:var(--info)"></i> Loan Disbursements</div>
        <div id="loanDisbursementList">Loading requests...</div>

        <div class="section-title"><i class="fas fa-arrow-circle-up" style="color:var(--danger)"></i> Standard Withdrawals</div>
        <div id="withdrawalList">Loading payouts...</div>

        <div class="section-title"><i class="fas fa-users"></i> Member Management</div>
        <input type="text" id="userSearch" class="search-box" placeholder="Search member name or phone..." oninput="renderUsers()">
        <div class="table-container">
            <table>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>
<div id="adminQuickPayModal" class="modal" style="display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8);">
    <div style="background:white; margin:10% auto; padding:20px; width:90%; max-width:400px; border-radius:15px; position:relative;">
        <span onclick="closeModal('adminQuickPayModal')" style="position:absolute; right:15px; top:10px; font-size:24px; cursor:pointer;">&times;</span>
        
        <h3>Manual Loan Payment</h3>
        <input type="text" id="adminUserSearch" placeholder="Search name or phone..." 
               onkeyup="filterQuickPayUsers()" 
               style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
        
        <div id="quickPayList" style="max-height:300px; overflow-y:auto;">
            </div>
    </div>
</div>

</div>


    <script>
        const SUPABASE_URL = 'https://bvnivavjmrmfnagwqvxc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2bml2YXZqbXJtZm5hZ3dxdnhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODE2NDksImV4cCI6MjA4Njg1NzY0OX0.KRKwRllUSm8lqJZQ1H68v9nQjXYh1fqw9qmlyAiFBS0';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allUsers = [];

        window.onload = loadAllData;

        async function loadAllData() {
            document.getElementById('lastRefreshed').innerText = "Refreshing...";
            
            // 1. Load Payments (Cash Main / Cash Loan / Interest)
            const { data: payments } = await client.from('contributions').select('*, profiles(full_name, phone)').eq('status', 'pending');
            renderPayments(payments);

            // 2. Load Loan Requests (Disbursements)
            const { data: loanReqs } = await client.from('loan_requests').select('*, profiles(full_name, phone)').eq('status', 'pending');
            renderLoanRequests(loanReqs);

            // 3. Load Standard Withdrawals
            const { data: withdrawals } = await client.from('withdrawals').select('*, profiles(full_name, phone)').eq('status', 'pending');
            renderWithdrawals(withdrawals);

            // 4. Load User Directory
            const { data: users } = await client.from('profiles').select('*').order('full_name');
            allUsers = users;
            renderUsers();

            updateStats(users, payments, loanReqs, withdrawals);
            document.getElementById('lastRefreshed').innerText = "Last synced: " + new Date().toLocaleTimeString();
        }

        function updateStats(users, p, l, w) {
            let mainTotal = users.reduce((acc, curr) => acc + (parseFloat(curr.balance) || 0), 0);
            let loanTotal = users.reduce((acc, curr) => acc + (parseFloat(curr.loan_balance) || 0), 0);
            document.getElementById('statMainBal').innerText = `₦${mainTotal.toLocaleString()}`;
            document.getElementById('statLoanBal').innerText = `₦${loanTotal.toLocaleString()}`;
            document.getElementById('statPending').innerText = (p?.length || 0) + (w?.length || 0);
            document.getElementById('statLoanReqs').innerText = (l?.length || 0);
        }

        function renderPayments(list) {
            const container = document.getElementById('paymentList');
            if(!list || list.length === 0) { container.innerHTML = '<p style="padding:15px; color:#999;">No pending payments</p>'; return; }
            
            container.innerHTML = list.map(item => `
                <div class="request-card">
                    <div class="req-info">
                        <div>
                            <div class="req-user">${item.profiles.full_name}</div>
                            <div class="req-meta">${item.profiles.phone}</div>
                            <span class="badge ${item.category === 'loan_savings' ? 'bg-loan' : 'bg-interest'}">${item.category.replace('_', ' ')}</span>
                        </div>
                        <div class="req-amount">₦${item.amount.toLocaleString()}</div>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-approve" onclick="approvePayment('${item.id}', '${item.user_id}', ${item.amount}, '${item.category}', '${item.profiles.phone}')">Confirm Recieved</button>
                        <button class="btn btn-reject" onclick="deleteRecord('contributions', '${item.id}')">Decline</button>
                    </div>
                </div>
            `).join('');
        }

        function renderLoanRequests(list) {
            const container = document.getElementById('loanDisbursementList');
            if(!list || list.length === 0) { container.innerHTML = '<p style="padding:15px; color:#999;">No loan requests</p>'; return; }

            container.innerHTML = list.map(item => `
                <div class="request-card" style="border-left: 5px solid var(--info);">
                    <div class="req-info">
                        <div>
                            <div class="req-user">${item.profiles.full_name}</div>
                            <div class="req-meta">${item.bank_name} | ${item.account_number}</div>
                            <small style="color:var(--primary); font-weight:bold;">Interest Prepaid: ₦${item.interest_amount}</small>
                        </div>
                        <div class="req-amount">₦${item.amount.toLocaleString()}</div>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-approve" style="background:var(--info)" onclick="approveLoanDisbursement('${item.id}', '${item.user_id}', ${item.amount}, '${item.profiles.phone}')">Mark Disbursed</button>
                        <button class="btn btn-reject" onclick="deleteRecord('loan_requests', '${item.id}')">Decline</button>
                    </div>
                </div>
            `).join('');
        }

        function renderWithdrawals(list) {
            const container = document.getElementById('withdrawalList');
            if(!list || list.length === 0) { container.innerHTML = '<p style="padding:15px; color:#999;">No pending withdrawals</p>'; return; }

            container.innerHTML = list.map(item => `
                <div class="request-card" style="border-left: 5px solid var(--danger);">
                    <div class="req-info">
                        <div>
                            <div class="req-user">${item.profiles.full_name}</div>
                            <div class="req-meta">${item.bank_name} | ${item.account_number}</div>
                        </div>
                        <div class="req-amount">₦${item.amount.toLocaleString()}</div>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-approve" style="background:var(--danger)" onclick="approveWithdrawal('${item.id}', '${item.user_id}', ${item.amount}, '${item.profiles.phone}')">Mark Paid</button>
                        <button class="btn btn-reject" onclick="deleteRecord('withdrawals', '${item.id}')">Decline</button>
                    </div>
                </div>
            `).join('');
        }

        function renderUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(u => u.full_name.toLowerCase().includes(search) || u.phone.includes(search));
            
            document.getElementById('userTableBody').innerHTML = filtered.map(u => `
                <tr>
                    <td>
                        <div style="font-weight:800; font-size:14px;">${u.full_name}</div>
                        <div style="font-size:11px; color:#888;">${u.phone}</div>
                        <div style="margin-top:5px;">
                            <span class="badge" style="background:#eee">Main: ₦${(u.balance || 0).toLocaleString()}</span>
                            <span class="badge" style="background:#eef2ff; color:#4f46e5">Loan: ₦${(u.loan_balance || 0).toLocaleString()}</span>
                        </div>
                    </td>
                    <td style="text-align:right">
                        <button class="btn" style="background:var(--dark); color:white; padding:8px 12px;" onclick="manualTopup('${u.id}', '${u.full_name}', '${u.phone}')"><i class="fas fa-plus"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        // --- ACTION LOGIC ---

        // --- UPDATED ACTION LOGIC ---

async function approvePayment(id, uid, amt, category, phone) {
    const { data: userProfile } = await client.from('profiles').select('*').eq('id', uid).single();
    let updateData = {};
    let msg = "";

    if (category === 'loan_repayment') {
        // Increment the day count upon approval
        updateData.loan_days = (userProfile.loan_days || 0) + 1;
        
        // Add the 20% portion of the base repayment back to their loan_balance
        const baseAmt = amt / 1.20; // Reversing the 20% markup to find base
        const savingsAdded = baseAmt * 0.20;
        updateData.loan_balance = (parseFloat(userProfile.loan_balance) || 0) + savingsAdded;
        
        msg = `Zoe: Cash repayment verified. You are now on Day ${updateData.loan_days}/90.`;
    } 
    // ... (keep your other category logic for loan_savings and main)

    await client.from('profiles').update(updateData).eq('id', uid);
    await client.from('contributions').update({ status: 'approved' }).eq('id', id);
    
    sendSms(phone, msg);
    loadAllData();
}

async function approveLoanDisbursement(id, uid, amt, phone) {
    if(!confirm("Confirm Disbursement: Have you transferred the funds? This starts the user at Day 0.")) return;

    // 1. Update Loan Request Status
    const { error: loanError } = await client.from('loan_requests')
        .update({ 
            status: 'approved',
            disbursed_at: new Date().toISOString() 
        })
        .eq('id', id);

    if (loanError) return alert("Update failed: " + loanError.message);

    // 2. Initialize Repayment Tracker (Reset to Day 0)
    const { error: profileError } = await client.from('profiles').update({
        loan_days: 0,
        updated_at: new Date().toISOString()
    }).eq('id', uid);

    if (profileError) return alert("Profile sync failed: " + profileError.message);

    // 3. UI Feedback
    document.getElementById('loanDisbursementList').innerHTML = "<p style='padding:15px;'>Syncing records...</p>";
    
    // 4. Send Notification & Refresh
    await sendSms(phone, `Zoe: Your loan of ₦${amt.toLocaleString()} is disbursed. Repayment starts at Day 0. Good luck!`);
    await loadAllData(); 
    
    alert("Loan marked as disbursed. User dashboard will now switch to Repayment Mode.");
}

// Function to show the modal and clear old search
function openAdminQuickPay() {
    document.getElementById('adminUserSearch').value = '';
    filterQuickPayUsers();
    document.getElementById('adminQuickPayModal').style.display = 'block';
}

function filterQuickPayUsers() {
    const searchTerm = document.getElementById('adminUserSearch').value.toLowerCase();
    const list = document.getElementById('quickPayList');
    
    // Filters based on the global allUsers array
    const filtered = allUsers.filter(u => 
        u.full_name.toLowerCase().includes(searchTerm) || u.phone.includes(searchTerm)
    );

    list.innerHTML = filtered.map(u => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
            <div>
                <strong>${u.full_name}</strong>
                <div style="font-size:11px; color:#888;">Day ${u.loan_days || 0}/90</div>
            </div>
            <button onclick="confirmManualTick('${u.id}', '${u.full_name}', ${u.loan_days || 0})" 
                    style="background:#28a745; color:white; border:none; padding:8px 12px; border-radius:5px;">
                Tick Paid
            </button>
        </div>
    `).join('');
}

async function confirmManualTick(uid, name, currentDay) {
    if (!confirm(`Mark Day ${currentDay + 1} as paid for ${name}?`)) return;

    // 1. Fetch User Profile and Loan in one go
    const { data: profile } = await client.from('profiles').select('*').eq('id', uid).single();
    
    const { data: loan } = await client.from('loan_requests')
        .select('amount')
        .eq('user_id', uid)
        .eq('status', 'approved')
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

    if (!loan) return alert("User has no active approved loan.");

    // 2. Perform Math
    const baseDaily = loan.amount / 90;
    const savingsToReturn = baseDaily * 0.20;
    const newDay = (currentDay || 0) + 1;
    const newLoanBal = (parseFloat(profile.loan_balance) || 0) + savingsToReturn;

    // 3. Update Database
    const { error } = await client.from('profiles').update({
        loan_days: newDay,
        loan_balance: newLoanBal
    }).eq('id', uid);

    if (!error) {
        // 4. Record Transaction
        await client.from('contributions').insert([{
            user_id: uid,
            amount: baseDaily * 1.20,
            status: 'approved',
            type: 'cash',
            category: 'loan_repayment'
        }]);

        // 5. FIXED: Close Modal logic
        // We target the specific floating div ID
        const modal = document.getElementById('adminQuickPayModal');
        if (modal) modal.style.display = 'none';

        // 6. FIXED: Send SMS using the phone from the profile we fetched
        if (profile.phone) {
            await sendSms(profile.phone, `Zoe Admin: Day ${newDay} payment confirmed. ₦${Math.round(savingsToReturn)} added to your wallet.`);
        }

        alert(`${name} is now on Day ${newDay}.`);
        loadAllData(); // Refresh main dashboard
    } else {
        alert("Update failed: " + error.message);
    }
}



        async function approveWithdrawal(id, uid, amt, phone) {
            if(!confirm("Mark as paid?")) return;
            // When standard withdrawal is approved, user balance is usually already deducted on request. 
            // If not, deduct it here. For safety, we just mark as completed.
            await client.from('withdrawals').update({ status: 'completed' }).eq('id', id);
            sendSms(phone, `Zoe Network: Your withdrawal of ₦${amt.toLocaleString()} has been paid. check your bank.`);
            loadAllData();
        }

        async function manualTopup(uid, name, phone) {
            const type = prompt(`Top up for ${name}\nType '1' for Main Balance\nType '2' for Loan Balance`);
            if(!type) return;
            const amt = prompt("Enter Amount:");
            if(!amt || isNaN(amt)) return alert("Invalid amount");

            let updateData = {};
            if(type === '1') updateData.balance = (allUsers.find(u => u.id === uid).balance || 0) + parseFloat(amt);
            else if(type === '2') updateData.loan_balance = (allUsers.find(u => u.id === uid).loan_balance || 0) + parseFloat(amt);
            else return alert("Invalid type");

            await client.from('profiles').update(updateData).eq('id', uid);
            sendSms(phone, `Zoe Admin: Your account has been manually credited with ₦${amt}.`);
            loadAllData();
        }

        async function deleteRecord(table, id) {
            if(!confirm("Are you sure you want to decline/delete this request?")) return;
            await client.from(table).delete().eq('id', id);
            loadAllData();
        }

        async function sendSms(phone, msg) {
            try {
                fetch(`${SUPABASE_URL}/functions/v1/Sms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
                    body: JSON.stringify({ phone, message: msg })
                });
            } catch(e) { console.error("SMS skip", e); }
        }
    </script>
</body>
</html>
